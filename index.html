<!doctype html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>教学视频黑板</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.5;margin:0;background:#f7f7fb;color:#111}
    header{padding:16px 20px;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.06);position:sticky;top:0}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .card{background:#fff;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px;overflow:hidden}
    .card h2{font-size:16px;margin:0 0 8px}
    .muted{color:#666;font-size:13px}
    video, audio, img{width:100%;border-radius:10px}
    pre{white-space:pre-wrap;word-break:break-word}
    .summary{padding:12px}
    .footer{color:#777;font-size:12px;margin:24px 0 40px}
    .tag{display:inline-block;background:#eef;border-radius:999px;padding:2px 8px;margin-right:6px;font-size:12px}
    .kbd{background:#eee;border-radius:6px;padding:2px 6px}
    a{color:#0a58ca;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
  <!-- 用于解压 #z=... 的压缩载荷（字幕/总结） -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
</head>
<body>
  <header>
    <h1 id="title">教学视频黑板</h1>
  </header>

  <div class="wrap">
    <div class="card">
      <h2>音频预览</h2>
      <audio id="audio" controls></audio>
      <div class="muted">如无法播放，检查 audio 参数是否为可直接访问的 mp3/m4a 链接。</div>
    </div>

    <div class="card">
      <h2>关键帧</h2>
      <div id="frames" class="grid"></div>
      <div class="muted">
        传参有两种方式：<br>
        ① 旧：<span class="kbd">frames=url1,url2,...</span><br>
        ② 新（推荐，短参）：<span class="kbd">frames_base=...&fstart=1&fend=N</span>
        （可选 <span class="kbd">prefix</span>、<span class="kbd">pad</span>、<span class="kbd">ext</span>）
      </div>
    </div>

    <div class="card">
      <h2>字幕（SRT 或纯文本）</h2>
      <pre id="srt" class="muted">正在加载…</pre>
    </div>

    <div class="card">
      <h2>教学要点（Markdown/HTML）</h2>
      <div id="summary" class="summary">（无）</div>
      <div class="muted">建议把渲染后的 Markdown 作为 HTML 放入 <span class="kbd">summary</span> 或哈希载荷。</div>
    </div>

    <div class="footer">
      支持参数：
      <span class="tag">title</span>
      <span class="tag">audio</span>
      <span class="tag">frames</span>
      <span class="tag">frames_base</span>
      <span class="tag">fstart</span>
      <span class="tag">fend</span>
      <span class="tag">prefix</span>
      <span class="tag">pad</span>
      <span class="tag">ext</span>
      <span class="tag">srt / srt_url</span>
      <span class="tag">summary / summary_url</span>
      <span class="tag">#z=压缩载荷</span>
      <div style="margin-top:8px">
        例（短参）：<code>?audio=https://.../audio.m4a&frames_base=https://.../input-frames/&fstart=1&fend=15#z=...</code>
      </div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);

    // ============ ① 从哈希读取压缩载荷（可包含 srt/summary 等大文本） ============
    let hashPayload = {};
    (function readHash(){
      try {
        const h = (location.hash || "").slice(1);     // 去掉 '#'
        if (!h) return;
        // 允许两种：z=（压缩）或 p=（未压缩 JSON，备用）
        const [k, v] = h.split("=", 2);
        if (k === "z") {
          const json = LZString.decompressFromEncodedURIComponent(v || "");
          if (json) hashPayload = JSON.parse(json);
        } else if (k === "p") {
          const json = decodeURIComponent(v || "");
          if (json) hashPayload = JSON.parse(json);
        }
      } catch (e) {
        // 忽略解析失败
      }
    })();

    // ============ ② 基础参数 ============
    const title   = qs.get("title") || "教学视频黑板";
    const audio   = qs.get("audio") || "";

    document.getElementById("title").textContent = title;
    if (audio) document.getElementById("audio").src = audio;

    // ============ ③ 关键帧（兼容旧参 + 新短参） ============
    function ensureSlashEnd(s){ return s ? (s.endsWith("/") ? s : s + "/") : s; }
    function padNum(n, width){ const s=String(n); return s.length>=width ? s : "0".repeat(width-s.length)+s; }

    const $frames = document.getElementById("frames");

    // 旧：frames=url1,url2,...
    const framesList = (qs.get("frames") || "")
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);

    // 新（短参）：frames_base + fstart + fend（可选 prefix / pad / ext）
    const framesBase = ensureSlashEnd(qs.get("frames_base") || "");
    const fstart     = parseInt(qs.get("fstart") || "0", 10);
    const fend       = parseInt(qs.get("fend")   || "0", 10);
    const prefix     = qs.get("prefix") || "input-frame_";
    const padLen     = parseInt(qs.get("pad") || "4", 10); // 0001
    const ext        = (qs.get("ext") || "jpg").replace(/^\./, "");

    const toRender = [...framesList];
    if (framesBase && fstart > 0 && fend >= fstart) {
      for (let i = fstart; i <= fend; i++) {
        toRender.push(`${framesBase}${prefix}${padNum(i, padLen)}.${ext}`);
      }
    }

    if (toRender.length) {
      toRender.forEach(url => {
        const img = new Image();
        img.loading = "lazy";
        img.decoding = "async";
        img.src = url;

        const card = document.createElement("div");
        card.className = "card";
        card.appendChild(img);
        $frames.appendChild(card);
      });
    } else {
      $frames.innerHTML = '<div class="muted">未传入 frames 或 frames_base/fstart/fend</div>';
    }

    // ============ ④ 字幕：优先 hash.srt -> srt_url -> srt（内嵌） ============
    const $srt = document.getElementById("srt");
    const srtFromHash = hashPayload.srt || "";
    const srtUrl  = qs.get("srt_url") || "";
    const srtText = qs.get("srt") || "";

    if (srtFromHash) {
      $srt.textContent = srtFromHash;
    } else if (srtUrl) {
      fetch(srtUrl).then(r => r.text()).then(t => $srt.textContent = t)
        .catch(() => $srt.textContent = "字幕加载失败，请检查 srt_url。");
    } else if (srtText) {
      // 允许直接放在 query 中（短文案）
      try { $srt.textContent = decodeURIComponent(srtText); }
      catch { $srt.textContent = srtText; }
    } else {
      $srt.textContent = "（无字幕）";
    }

    // ============ ⑤ 教学要点：优先 hash.summary -> summary_url -> summary ============
    const $summary = document.getElementById("summary");
    const summaryFromHash = hashPayload.summary || "";
    const summaryUrl   = qs.get("summary_url") || "";
    const summaryQuery = qs.get("summary") || "";

    if (summaryFromHash) {
      // 建议注入已渲染 HTML
      $summary.innerHTML = summaryFromHash;
    } else if (summaryUrl) {
      fetch(summaryUrl).then(r => r.text()).then(html => $summary.innerHTML = html)
        .catch(() => $summary.textContent = "教学要点加载失败，请检查 summary_url。");
    } else if (summaryQuery) {
      // 兼容直接传 HTML/Markdown 文本（建议先在服务端渲染成 HTML 再传）
      try { $summary.innerHTML = decodeURIComponent(summaryQuery); }
      catch { $summary.textContent = summaryQuery; }
    } else {
      $summary.textContent = "（无）";
    }
  </script>
</body>
</html>
