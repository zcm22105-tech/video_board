<!doctype html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>教学视频黑板</title>

  <!-- 简洁教学主题样式（浅色、层级清晰、图标化标题） -->
  <style>
    :root{
      --bg:#f6f8fa;          /* 页面背景 */
      --fg:#1f2328;          /* 正文颜色 */
      --muted:#57606a;       /* 次要文字 */
      --primary:#2563eb;     /* 主色 */
      --card:#ffffff;        /* 卡片底色 */
      --border:#e6e8eb;      /* 边框色 */
      --shadow:rgba(16,24,40,.08);
    }
    html,body{height:100%}
    body{
      margin:0;
      /* 优先中文衬线（宋体/仿宋），再降级到思源宋体与系统衬线 */
      font-family:"FangSong","SimSun","Songti SC","Source Han Serif SC","Noto Serif SC",Georgia,Times,serif;
      color:var(--fg);
      background:var(--bg);
    }

    header{
      position:sticky; top:0; z-index:5;
      background:#ffffff;
      border-bottom:1px solid var(--border);
      box-shadow:0 4px 12px var(--shadow);
    }
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px}

    h1{
      margin:12px 16px;
      font-size:24px;
      color:var(--fg);
      font-weight:600;
      letter-spacing:.2px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      margin:16px 0;
      box-shadow:0 6px 18px var(--shadow);
    }

    /* 统一的分节标题，带图标标识（通过 data-ic 控制） */
    .chalk-h2{
      margin:0 0 12px;
      font-size:18px;
      color:var(--fg);
      font-weight:600;
      display:flex; align-items:center; gap:.5rem;
    }
    .chalk-h2::before{
      content: attr(data-ic);
      display:inline-flex; align-items:center; justify-content:center;
      width:26px; height:26px; border-radius:6px;
      background:rgba(37,99,235,.08); color:var(--primary);
      font-size:14px; line-height:1; border:1px solid rgba(37,99,235,.18);
    }

    .muted{ color:var(--muted); font-size:13px }

    audio{width:100%; border-radius:10px}

    /* ---------- 关键帧：水平胶片条 + 小方块缩略图 ---------- */
    .filmstrip{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding:6px 4px 2px;
      scrollbar-width:thin;
    }
    .filmstrip::-webkit-scrollbar{height:8px}
    .filmstrip::-webkit-scrollbar-thumb{background:rgba(0,0,0,.2); border-radius:8px}
    .thumb{
      width:96px; height:96px;       /* 小小正方块缩略图 */
      border-radius:10px;
      object-fit:cover;
      box-shadow:0 4px 10px var(--shadow);
      border:1px solid var(--border);
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
      background:#f3f4f6;
    }
    .thumb:hover{ transform:scale(1.04); box-shadow:0 6px 14px rgba(0,0,0,.25) }

    /* ---------- 图片查看器（放大预览 + 上/下/关闭） ---------- */
    .lightbox{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      background:rgba(0,0,0,.65);
      z-index:99;
    }
    .lightbox.open{ display:flex }
    .lightbox img{
      max-width:min(92vw,1050px);
      max-height:88vh;
      border-radius:12px;
      box-shadow:0 20px 80px rgba(0,0,0,.45);
    }
    .lb-btn{
      position:absolute; top:50%; transform:translateY(-50%);
      background:#ffffffcc;
      border:1px solid var(--border);
      color:#111; padding:8px 12px; border-radius:10px; cursor:pointer;
      user-select:none;
      backdrop-filter: blur(6px);
    }
    .lb-prev{ left:24px }
    .lb-next{ right:24px }
    .lb-close{
      top:18px; right:18px; transform:none;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.25);
    }

    /* ---------- 字幕/总结展示 ---------- */
    pre{ white-space:pre-wrap; word-break:break-word; color:var(--fg) }

    /* 课堂小结内的标题层级：整体小于模块标题（18px） */
    #summary h1{ font-size:16px; margin:10px 0 6px; font-weight:600 }
    #summary h2{ font-size:15px; margin:10px 0 6px; font-weight:600 }
    #summary h3{ font-size:14px; margin:8px 0 6px; font-weight:600 }
    #summary h4{ font-size:13px; margin:6px 0 4px; font-weight:600 }
    #summary p{ margin:8px 0; color:var(--fg) }
    #summary ul{ margin:6px 0 6px 22px }
    #summary li{ margin:4px 0 }
    #summary blockquote{ border-left:3px solid var(--border); padding-left:10px; color:var(--muted) }
  </style>

  <!-- 大文本压缩/解压（兼容 #z=） -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <!-- Markdown 渲染（把 # 语法变成排版良好的 HTML） -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <header><h1>课堂演示面板</h1></header>
  <div class="wrap">

    <div class="card">
      <h2 class="chalk-h2" data-ic="♪">课堂导入 · 音频</h2>
      <audio id="audio" controls></audio>
    </div>

    <div class="card">
      <h2 class="chalk-h2" data-ic="▦">课堂投影 · 关键帧速览</h2>
      <div id="strip" class="filmstrip"></div>
      <div class="muted">点击任意缩略图可放大预览，支持左右切换与关闭。</div>
    </div>

    <div class="card">
      <h2 class="chalk-h2" data-ic="⌨">字幕记录</h2>
      <pre id="srt" class="muted">正在加载…</pre>
    </div>

    <div class="card">
      <h2 class="chalk-h2" data-ic="✦">课堂小结 · 要点</h2>
      <div id="summary">（无）</div>
    </div>
  </div>

  <!-- 放大查看器 -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <button class="lb-btn lb-prev" id="lbPrev">‹ 上一张</button>
    <img id="lbImg" alt="预览"/>
    <button class="lb-btn lb-next" id="lbNext">下一张 ›</button>
    <button class="lb-btn lb-close" id="lbClose">✕ 关闭</button>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);

    /* ========== 读取哈希载荷（#z= 压缩 / #p= 未压缩 JSON） ========== */
    let hashPayload = {};
    (function(){
      try{
        const raw = (location.hash || "").slice(1);
        if(!raw) return;
        const [k,v] = raw.split("=",2);
        if(k==="z"){
          const json = LZString.decompressFromEncodedURIComponent(v||"");
          if(json) hashPayload = JSON.parse(json);
        }else if(k==="p"){
          const json = decodeURIComponent(v||"");
          if(json) hashPayload = JSON.parse(json);
        }
      }catch{}
    })();

    /* ========== 基础参数 ========== */
    const title = qs.get("title") || "教学视频黑板";
    document.querySelector("h1").textContent = title;

    const audioUrl = qs.get("audio") || "";
    if(audioUrl) document.getElementById("audio").src = audioUrl;

    /* ========== 关键帧：旧参 frames 或短参 frames_base/fstart/fend（+prefix/pad/ext） ========== */
    function ensureSlashEnd(s){ return s ? (s.endsWith("/") ? s : s + "/") : s; }
    function padNum(n,w){ const s=String(n); return s.length>=w ? s : "0".repeat(w-s.length)+s; }

    const framesList = (qs.get("frames")||"").split(",").map(s=>s.trim()).filter(Boolean);
    const base   = ensureSlashEnd(qs.get("frames_base")||"");
    const fstart = parseInt(qs.get("fstart")||"0",10);
    const fend   = parseInt(qs.get("fend")  ||"0",10);
    const prefix = qs.get("prefix") || "input-frame_";
    const pad    = parseInt(qs.get("pad") || "4", 10);
    const ext    = (qs.get("ext")  || "jpg").replace(/^\./,"");

    const images = [...framesList];
    if(base && fstart>0 && fend>=fstart){
      for(let i=fstart;i<=fend;i++){
        images.push(`${base}${prefix}${padNum(i,pad)}.${ext}`);
      }
    }

    // 渲染缩略图到水平胶片条
    const strip = document.getElementById("strip");
    let cur = 0;
    function openLightbox(idx){
      if(!images.length) return;
      cur = (idx+images.length)%images.length;
      lbImg.src = images[cur];
      lightbox.classList.add("open");
      lightbox.setAttribute("aria-hidden","false");
    }
    function closeLightbox(){
      lightbox.classList.remove("open");
      lightbox.setAttribute("aria-hidden","true");
      lbImg.src="";
    }
    function next(){ openLightbox(cur+1); }
    function prev(){ openLightbox(cur-1); }

    if(images.length){
      images.forEach((url,i)=>{
        const img = new Image();
        img.className="thumb";
        img.loading="lazy";
        img.decoding="async";
        img.src = url;
        img.alt = `关键帧 ${i+1}`;
        img.onclick = ()=>openLightbox(i);
        strip.appendChild(img);
      });
    }else{
      strip.innerHTML = '<div class="muted">未提供关键帧参数。</div>';
    }

    // Lightbox 事件
    const lightbox = document.getElementById("lightbox");
    const lbImg = document.getElementById("lbImg");
    document.getElementById("lbClose").onclick = closeLightbox;
    document.getElementById("lbNext").onclick  = next;
    document.getElementById("lbPrev").onclick  = prev;
    lightbox.addEventListener("click",e=>{ if(e.target===lightbox) closeLightbox(); });
    window.addEventListener("keydown",e=>{
      if(!lightbox.classList.contains("open")) return;
      if(e.key==="Escape") closeLightbox();
      if(e.key==="ArrowRight") next();
      if(e.key==="ArrowLeft") prev();
    });

    /* ========== 字幕 ========== */
    const $srt = document.getElementById("srt");
    const srtFromHash = hashPayload.srt || "";
    const srtUrl  = qs.get("srt_url") || "";
    const srtText = qs.get("srt") || "";

    if(srtFromHash){
      $srt.textContent = srtFromHash;
    }else if(srtUrl){
      fetch(srtUrl).then(r=>r.text()).then(t=> $srt.textContent=t)
        .catch(()=> $srt.textContent="字幕加载失败。");
    }else if(srtText){
      try{ $srt.textContent = decodeURIComponent(srtText); }
      catch{ $srt.textContent = srtText; }
    }else{
      $srt.textContent = "（无字幕）";
    }

    /* ========== 课堂小结（Markdown → HTML） ========== */
    const $summary  = document.getElementById("summary");
    const sumHash   = hashPayload.summary || "";
    const sumUrl    = qs.get("summary_url") || "";
    const sumQuery  = qs.get("summary") || "";

    function renderSummary(mdOrHtml){
      // 简单判断：含有 markdown 常见标记就当 Markdown 渲染，否则按 HTML 注入
      const looksLikeMd = /(^|\n)\s{0,3}(#{1,6}\s|-\s|\*\s|\d+\.\s|>|\|)/.test(mdOrHtml);
      if(looksLikeMd){
        $summary.innerHTML = marked.parse(mdOrHtml, { breaks:true, gfm:true });
      }else{
        $summary.innerHTML = mdOrHtml;
      }
    }

    if(sumHash){
      renderSummary(sumHash);
    }else if(sumUrl){
      fetch(sumUrl).then(r=>r.text()).then(t=> renderSummary(t))
        .catch(()=> $summary.textContent="教学要点加载失败。");
    }else if(sumQuery){
      let txt = "";
      try{ txt = decodeURIComponent(sumQuery); } catch{ txt = sumQuery; }
      renderSummary(txt);
    }else{
      $summary.textContent = "（无）";
    }
  </script>
</body>
</html>
